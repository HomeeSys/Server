name: Build and publish microservices

on:
  push:
    branches:
      - master

jobs:
  build_and_push:
    name: Build and push Docker images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [Devices, Measurements, Raports, Emulators, Gateways]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          SERVICE="${{ matrix.service }}"
          SERVICE_LOWER=$(echo "$SERVICE" | tr '[:upper:]' '[:lower:]')

          # Map service â†’ Dockerfile path
          case "$SERVICE" in
            Devices) DOCKERFILE="Services/Devices/Devices.API/Dockerfile" ;;
            Measurements) DOCKERFILE="Services/Measurements/Measurements.API/Dockerfile" ;;
            Raports) DOCKERFILE="Services/Raports/Raports.API/Dockerfile" ;;
            Emulators) DOCKERFILE="Services/Emulators/Emulators.WebApp/Dockerfile" ;;
            Gateways) DOCKERFILE="Services/Gateways/Gateways.Main/Dockerfile" ;;
            *) echo "Unknown service: $SERVICE"; exit 1 ;;
          esac

          if [ ! -f "$DOCKERFILE" ]; then
            echo "Dockerfile $DOCKERFILE not found for $SERVICE"
            exit 1
          fi

          echo "Building Docker image for $SERVICE"
          docker build -f $DOCKERFILE -t darekkrawczyk/homee.server.$SERVICE_LOWER:latest .

      - name: Push Docker image
        env:
          DOCKERHUB_TOKEN: ${{ secrets.HOMEE_DOCKERHUB_TOKEN }}
        run: |
          SERVICE="${{ matrix.service }}"
          SERVICE_LOWER=$(echo "$SERVICE" | tr '[:upper:]' '[:lower:]')

          echo $DOCKERHUB_TOKEN | docker login -u darekkrawczyk --password-stdin
          docker push darekkrawczyk/homee.server.$SERVICE_LOWER:latest